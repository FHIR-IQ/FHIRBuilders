// FHIRBuilders Platform Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Authentication & User Management
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  bio           String?   @db.Text

  // Persona & Profile
  persona       Persona   @default(BUILDER)
  role          Role      @default(USER)
  skills        String[]  // ["FHIR", "AI/ML", "React", "Python"]
  interests     String[]  // ["oncology", "patient-engagement", "interoperability"]
  lookingFor    String[]  // ["co-founder", "investor", "mentor", "collaborator"]

  // Organization
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  // Integrations
  githubUsername    String?
  huggingfaceUsername String?

  // Relationships
  accounts      Account[]
  sessions      Session[]
  apps          App[]
  projects      ProjectMember[]
  sandboxes     Sandbox[]
  upvotes       Upvote[]
  comments      Comment[]
  integrations  Integration[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// Organization
// ============================================

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  website     String?
  logo        String?
  type        OrgType
  verified    Boolean  @default(false)

  users       User[]
  apps        App[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// Marketplace - Apps
// ============================================

model App {
  id            String    @id @default(cuid())
  name          String
  slug          String    @unique
  tagline       String    // Short description (max 100 chars)
  description   String    @db.Text
  category      Category

  // FHIR Details
  fhirResources String[]  // ["Patient", "Observation", "MedicationRequest"]
  fhirVersion   String    @default("R4")

  // Links
  repoUrl       String?
  demoUrl       String?
  docsUrl       String?

  // Media
  icon          String?
  screenshots   String[]
  videoUrl      String?

  // Status
  status        AppStatus @default(DRAFT)
  featured      Boolean   @default(false)

  // Metrics
  downloads     Int       @default(0)
  upvoteCount   Int       @default(0)

  // AI Tool Integration
  builtWith     String[]  // ["Claude Code", "Cursor", "Lovable"]

  // Relationships
  authorId      String
  author        User      @relation(fields: [authorId], references: [id])
  orgId         String?
  organization  Organization? @relation(fields: [orgId], references: [id])
  upvotes       Upvote[]
  ratings       Rating[]
  comments      Comment[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Rating {
  id        String   @id @default(cuid())
  score     Int      // 1-5
  review    String?  @db.Text

  appId     String
  app       App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  userId    String

  createdAt DateTime @default(now())

  @@unique([appId, userId])
}

// ============================================
// Sandbox
// ============================================

model Sandbox {
  id          String   @id @default(cuid())
  name        String
  description String?

  // Medplum Project Info
  medplumProjectId String?
  medplumBaseUrl   String?

  // Data Configuration
  patientCount Int      @default(10)
  dataModules  String[] // ["diabetes", "covid19", "heart_disease"]

  // Status
  status       SandboxStatus @default(PENDING)

  // Relationships
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  projectId    String?
  project      Project? @relation(fields: [projectId], references: [id])

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ============================================
// Collaboration
// ============================================

model Project {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String     @db.Text

  // Settings
  visibility  Visibility @default(PRIVATE)
  openToCollaborate Boolean @default(false)

  // Problem & Pitch
  problemStatement String?  @db.Text
  targetAudience   String?

  // Relationships
  members     ProjectMember[]
  sandboxes   Sandbox[]
  discussions Discussion[]
  pitch       Pitch?
  upvotes     Upvote[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model ProjectMember {
  projectId  String
  userId     String
  role       MemberRole @default(MEMBER)

  project    Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  joinedAt   DateTime   @default(now())

  @@id([projectId, userId])
}

model Discussion {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  category    DiscussionCategory
  pinned      Boolean  @default(false)
  locked      Boolean  @default(false)

  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])

  comments    Comment[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Comment {
  id           String   @id @default(cuid())
  content      String   @db.Text

  userId       String
  user         User     @relation(fields: [userId], references: [id])

  discussionId String?
  discussion   Discussion? @relation(fields: [discussionId], references: [id], onDelete: Cascade)

  appId        String?
  app          App?     @relation(fields: [appId], references: [id], onDelete: Cascade)

  parentId     String?
  parent       Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies      Comment[] @relation("CommentReplies")

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ============================================
// Pitch & Funding
// ============================================

model Pitch {
  id          String      @id @default(cuid())

  // Content
  problem     String      @db.Text
  solution    String      @db.Text
  market      String?     @db.Text
  traction    String?     @db.Text
  team        String?     @db.Text
  ask         String?     // Funding ask amount/terms

  // Media
  videoUrl    String?
  deckUrl     String?     // Pitch deck PDF

  // Status
  status      PitchStatus @default(DRAFT)
  featured    Boolean     @default(false)

  // Relationships
  projectId   String      @unique
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

// ============================================
// Engagement - Upvotes & Momentum
// ============================================

model Upvote {
  id        String   @id @default(cuid())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  appId     String?
  app       App?     @relation(fields: [appId], references: [id], onDelete: Cascade)

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, appId])
  @@unique([userId, projectId])
}

// ============================================
// Integrations
// ============================================

model Integration {
  id           String          @id @default(cuid())
  type         IntegrationType

  // OAuth Tokens
  accessToken  String?         @db.Text
  refreshToken String?         @db.Text
  expiresAt    DateTime?

  // Integration-specific data
  metadata     Json?

  userId       String
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@unique([userId, type])
}

// ============================================
// Enums
// ============================================

enum Persona {
  BUILDER     // Developers creating FHIR apps
  INVESTOR    // VCs, angels, healthcare funds
  SUPPORTER   // Mentors, advisors, domain experts
  USER        // Healthcare orgs using apps
}

enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

enum OrgType {
  HOSPITAL
  HEALTH_SYSTEM
  VENDOR
  STARTUP
  RESEARCH
  NONPROFIT
  GOVERNMENT
}

enum Category {
  AI_AGENT            // Agentic AI apps for clinical workflows
  CLINICAL            // EHR integrations, clinical decision support
  PATIENT_ENGAGEMENT  // Patient portals, scheduling, messaging
  ANALYTICS           // Population health, reporting, dashboards
  INTEGRATION         // Data exchange, interoperability tools
  TEMPLATE            // Starter templates and boilerplates
}

enum AppStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  APPROVED
  FEATURED
  ARCHIVED
}

enum SandboxStatus {
  PENDING
  PROVISIONING
  ACTIVE
  FAILED
  DELETED
}

enum Visibility {
  PRIVATE
  PUBLIC
  ORGANIZATION
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum DiscussionCategory {
  GENERAL
  FHIR_DEVELOPMENT
  AI_ML
  SMART_ON_FHIR
  INTEGRATION_PATTERNS
  REGULATORY
  SHOW_AND_TELL
  HELP_WANTED
}

enum PitchStatus {
  DRAFT
  PUBLISHED
  FEATURED
  ARCHIVED
}

enum IntegrationType {
  GITHUB
  HUGGINGFACE
  ZULIP
}

// ============================================
// Early Access / Validation
// ============================================

model Waitlist {
  id           String   @id @default(cuid())
  email        String   @unique

  // User profile
  persona      String?  // developer, healthcare, investor, learner
  building     String   // What they're building/interested in
  painPoint    String?  // Their biggest challenge
  lookingFor   String?  // What they're seeking (comma-separated)
  canInterview Boolean  @default(false) // Open to 15-min call

  // Validation tracking
  status       WaitlistStatus @default(PENDING)
  notes        String?  @db.Text // Internal notes

  // Onboarding tracking
  sandboxCreated Boolean  @default(false)
  welcomeEmailSent Boolean @default(false)
  interviewCompleted Boolean @default(false)
  feedbackReceived Boolean @default(false)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

enum WaitlistStatus {
  PENDING       // Just signed up
  SELECTED      // Selected for first 20
  ONBOARDING    // Sandbox being created
  ACTIVE        // Has active sandbox
  CHURNED       // Stopped using
  CONVERTED     // Became full user
}

model Feedback {
  id           String   @id @default(cuid())
  email        String?

  // Survey responses
  easeOfUse    Int?     // 1-5 scale
  dataFit      String?  // "yes", "partially", "no"
  whatBuilt    String?  @db.Text
  topRequest   String?  @db.Text
  nps          Int?     // 0-10 Net Promoter Score
  canShare     Boolean  @default(false)

  createdAt    DateTime @default(now())
}

// Simple project sharing for early validation
model SharedProject {
  id           String   @id @default(cuid())
  title        String
  description  String   @db.Text
  repoUrl      String?
  demoUrl      String?
  tags         String[]

  // Author info (pre-auth)
  authorName   String
  authorEmail  String?

  // Engagement
  upvoteCount  Int      @default(0)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
